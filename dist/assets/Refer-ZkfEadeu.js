import{c as H,r as n,u as M,w as Q,x as z,j as e,B as l,m as p}from"./index-BbDgdMef.js";import{B as m}from"./button-DSIJFCHW.js";import{L as I,I as q}from"./label-RL2mR4kJ.js";import{C as g,b as y,c as j,a as b}from"./card-IuV4J6Io.js";import{B as G}from"./badge-NjtBvO8a.js";import{T as F}from"./trophy-BWWA7n6L.js";import{S as w}from"./share-2-CxTWyYmr.js";import{U}from"./users-B27XVgMN.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=H("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),ae=()=>{const[f,T]=n.useState(""),[R,C]=n.useState([]),[Y,B]=n.useState(!0),[x,N]=n.useState(""),[c,_]=n.useState(!1),[d,S]=n.useState(""),[k,E]=n.useState([]),[v,D]=n.useState(0),{user:i}=M(),{toast:o}=Q(),L=z();if(!i)return e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Sign In Required"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"Please sign in to access the Refer page."}),e.jsx(m,{onClick:()=>L("/login"),children:"Sign In"})]})});const P=async()=>{for(;;){const r=Math.random().toString(36).substring(2,10).toUpperCase(),{data:a,error:t}=await l.from("registrations").select("id").eq("referral_code",r).maybeSingle();if(t)throw t;if(!a)return r}};n.useEffect(()=>{if(i){u(),h();const r=l.channel("registrations-changes").on("postgres_changes",{event:"*",schema:"public",table:"registrations"},t=>{console.log("Registration change detected:",t),u(),h()}).subscribe(),a=setInterval(()=>{u(),h()},3e4);return()=>{l.removeChannel(r),clearInterval(a)}}},[i]);const u=async()=>{try{const{data:r,error:a}=await l.from("registrations").select("referral_code, id, referred_by, total_referrals").eq("user_id",i.id).maybeSingle();if(a)throw console.error("Registration query error:",a),a;if(r){if(_(!0),T(r.referral_code),D(r.total_referrals||0),console.log("Registration data:",r),console.log("referred_by:",r.referred_by),r.referred_by)try{console.log("Fetching referrer data for ID:",r.referred_by);const{data:t,error:s}=await l.from("registrations").select("referral_code").eq("id",r.referred_by).maybeSingle();s?console.error("Referrer query error:",s):t&&t.referral_code&&(console.log("Setting referral code from referrer fetch:",t.referral_code),S(t.referral_code),N(t.referral_code))}catch(t){console.error("Error fetching referrer data:",t)}else console.log("No referred_by value, clearing referral codes"),S(""),N("");try{const{data:t,error:s}=await l.from("registrations").select("fullName, email, created_at").eq("referred_by",r.id);s?console.error("Referrals query error:",s):C(t||[])}catch(t){console.error("Error fetching referrals:",t),C([])}}else console.log("No registration found for user"),_(!1)}catch(r){console.error("Error fetching referral data:",r),o({title:"Error",description:`Failed to load referral data: ${r.message||"Unknown error"}`,variant:"destructive"})}finally{B(!1)}},h=async()=>{try{const{data:r,error:a}=await l.from("registrations").select("id, fullName, email, institution, total_referrals").gt("total_referrals",0).order("total_referrals",{ascending:!1}).limit(10);if(a){console.error("Leaderboard query error:",a);return}const t=(r||[]).map(s=>({id:s.id,fullName:s.fullName||"Unknown",email:s.email||"Unknown",institution:s.institution||"Unknown",count:s.total_referrals||0}));E(t)}catch(r){console.error("Error fetching leaderboard:",r),E([])}},$=()=>{navigator.clipboard.writeText(f),o({title:"Copied!",description:"Referral code copied to clipboard."})},A=()=>{const r=`${window.location.origin}/register?ref=${f}`;navigator.share?navigator.share({title:"Join Qiskit Fall Fest 2025",text:"Use my referral code to register!",url:r}):(navigator.clipboard.writeText(r),o({title:"Link Copied!",description:"Referral link copied to clipboard."}))},O=async()=>{if(d){o({title:"Referral Code Locked",description:"You have already applied a referral code. It cannot be changed.",variant:"destructive"});return}if(!x.trim()){o({title:"Error",description:"Please enter a referral code.",variant:"destructive"});return}if(x.trim()===f){o({title:"Invalid Code",description:"You cannot use your own referral code.",variant:"destructive"});return}try{let r=null;const{data:a}=await l.from("registrations").select("id, user_id").eq("referral_code",x.trim()).single();if(a){if(a.user_id===i.id){o({title:"Invalid Code",description:"You cannot use your own referral code.",variant:"destructive"});return}r=a.id}else{o({title:"Invalid Code",description:"The referral code you entered is invalid.",variant:"destructive"});return}if(c){const{data:t}=await l.from("registrations").select("referred_by").eq("user_id",i.id).single();if(t&&t.referred_by){o({title:"Referral Code Locked",description:"You have already applied a referral code. It cannot be changed.",variant:"destructive"});return}const{error:s}=await l.from("registrations").update({referred_by:r}).eq("user_id",i.id);if(s)throw s}else{const t=await P(),{error:s}=await l.from("registrations").insert([{user_id:i.id,fullName:i.user_metadata?.full_name||i.email,email:i.email,referral_code:t,referred_by:r}]);if(s)throw s}o({title:"Referral Applied!",description:"Your referral code has been applied successfully."}),u(),h()}catch(r){console.error("Error applying referral code:",r),o({title:"Error",description:"Failed to apply referral code. Please try again.",variant:"destructive"})}};return Y?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx("p",{children:"Loading..."})]})}):c?e.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},className:"min-h-screen bg-background py-20",children:e.jsx("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs(p.div,{initial:{opacity:0,y:30},animate:{opacity:1,y:0},transition:{duration:.8},className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-12",children:[e.jsx("h1",{className:"text-4xl lg:text-5xl font-bold font-poppins mb-4",children:"Refer & Earn"}),e.jsx("p",{className:"text-lg text-muted-foreground mb-6",children:"Share your referral code and invite friends to join Qiskit Fall Fest 2025"}),c&&e.jsxs("div",{className:"inline-flex items-center gap-3 bg-primary/10 border border-primary/20 rounded-full px-6 py-3",children:[e.jsx(F,{className:"h-5 w-5 text-primary"}),e.jsxs("span",{className:"text-lg font-semibold",children:["You have referred ",e.jsx("span",{className:"text-2xl font-bold text-primary",children:v})," people"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12",children:[e.jsxs(g,{className:"glass-card border border-white/10",children:[e.jsx(y,{children:e.jsxs(j,{className:"flex items-center",children:[e.jsx(w,{className:"h-5 w-5 mr-2 text-primary"}),"Friend's Referral Code"]})}),e.jsxs(b,{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs(I,{htmlFor:"friendReferralCode",children:["Referral Code ",d&&"🔒"]}),e.jsx(q,{id:"friendReferralCode",type:"text",value:x,onChange:r=>N(r.target.value),placeholder:"Enter your friend's referral code",className:`font-mono ${d?"bg-muted cursor-not-allowed":""}`,disabled:!!d,readOnly:!!d})]}),e.jsx(m,{onClick:O,className:"w-full",disabled:!!d,children:d?"Referral Code Locked":"Apply Referral Code"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:d?"🔒 You have already been referred by someone and cannot be referred again.":"Enter a referral code from a friend to earn rewards!"})]})]}),e.jsxs(g,{className:"glass-card border border-white/10",children:[e.jsx(y,{children:e.jsxs(j,{className:"flex items-center",children:[e.jsx(w,{className:"h-5 w-5 mr-2 text-primary"}),"Your Referral Code"]})}),e.jsx(b,{className:"space-y-4",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(I,{children:"Referral Code"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(q,{value:f,readOnly:!0,className:"font-mono"}),e.jsx(m,{onClick:$,variant:"outline",children:e.jsx(J,{className:"h-4 w-4"})})]})]}),e.jsxs(m,{onClick:A,className:"w-full",children:[e.jsx(w,{className:"h-4 w-4 mr-2"}),"Share Referral Link"]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Share this code with friends during registration to earn rewards!"})]}):e.jsx("p",{className:"text-muted-foreground",children:"Register to Generate Your Own Referral Code."})})]}),e.jsxs(g,{className:"glass-card border border-white/10",children:[e.jsx(y,{children:e.jsxs(j,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(U,{className:"h-5 w-5 mr-2 text-primary"}),"People You've Referred"]}),c&&v>0&&e.jsxs(G,{variant:"secondary",className:"bg-primary/20 text-primary",children:[v," Total"]})]})}),e.jsx(b,{children:c?R.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(U,{className:"h-12 w-12 text-muted-foreground/40 mx-auto mb-3"}),e.jsx("p",{className:"text-muted-foreground mb-2",children:"No referrals yet. Start sharing!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Share your referral code to see referred users here."})]}):e.jsxs("div",{className:"space-y-3 max-h-64 overflow-y-auto",children:[e.jsx("div",{className:"text-sm text-muted-foreground mb-3",children:"Referred Users:"}),R.map((r,a)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg hover:bg-muted/70 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary/20 rounded-full flex items-center justify-center text-primary font-semibold text-sm",children:a+1}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:r.fullName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.email})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:new Date(r.created_at).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})})})]},a))]}):e.jsx("div",{className:"text-center py-6",children:e.jsx("p",{className:"text-muted-foreground",children:"Complete registration to start referring others."})})})]})]}),e.jsx("div",{className:"max-w-2xl mx-auto",children:e.jsxs(g,{className:"glass-card border border-white/10",children:[e.jsx(y,{children:e.jsxs(j,{className:"flex items-center justify-center",children:[e.jsx(F,{className:"h-6 w-6 mr-3 text-primary"}),"Top 10 Referrers Leaderboard"]})}),e.jsx(b,{children:k.length===0?e.jsx("p",{className:"text-muted-foreground text-center",children:"No referrals yet. Be the first!"}):e.jsx("div",{className:"space-y-4",children:k.map((r,a)=>e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted/50 rounded-lg hover:bg-muted/70 transition-colors border-l-4 border-l-transparent hover:border-l-primary/50",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-br from-primary/20 to-primary/10",children:e.jsx("span",{className:"text-xl font-bold",children:a===0?e.jsx("span",{className:"text-yellow-500",children:"🏆"}):a===1?e.jsx("span",{className:"text-gray-400",children:"🥈"}):a===2?e.jsx("span",{className:"text-amber-600",children:"🥉"}):e.jsxs("span",{className:"text-primary font-bold",children:["#",a+1]})})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-lg",children:r.fullName}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.institution||"Institution not specified"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-2xl font-bold text-primary",children:r.count}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["referral",r.count!==1?"s":""]})]})]},r.id))})})]})})]})})}):e.jsx(p.div,{initial:{opacity:0},animate:{opacity:1},className:"min-h-screen bg-background py-20",children:e.jsx("div",{className:"container mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs(p.div,{initial:{y:30,opacity:0},animate:{y:0,opacity:1},transition:{duration:.8},className:"max-w-4xl mx-auto text-center",children:[e.jsx("h1",{className:"text-4xl lg:text-5xl font-bold font-poppins mb-8",children:"Refer & Earn"}),e.jsx("p",{className:"text-xl text-muted-foreground mb-12",children:"Complete your registration first to access the referral program and start earning rewards!"}),e.jsx(m,{onClick:()=>L("/register"),className:"btn-quantum",children:"Register Now"})]})})})};export{ae as default};
